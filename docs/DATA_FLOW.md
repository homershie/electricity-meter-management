# 資料流向

> 本文件詳細說明電表階層管理系統的資料流向、核心運作流程與狀態管理。

## 📋 目錄

- [核心運作流程](#核心運作流程)
- [資料流向](#資料流向)
- [狀態管理](#狀態管理)

---

## 核心運作流程

### 1. 初始資料載入流程

```
┌─────────────────┐
│  頁面載入       │
│  (index.vue)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  onMounted()    │
│  觸發載入       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ store.loadNodes()│
│  (nodesStore)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 呼叫 API        │
│ GET /api/nodes  │
│ ?flat=true      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 取得後端資料    │
│ (扁平化陣列)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 存入 Pinia      │
│ store.nodes     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 從 localStorage │
│ 恢復 UI 狀態    │
│ - selectedIds   │
│ - expandedIds   │
└─────────────────┘
```

**程式碼位置**:

- `app/pages/index.vue`: 第 50-56 行
- `app/stores/nodesStore.ts`: 第 63-81 行

---

### 2. 節點移動完整流程

```
┌─────────────────────┐
│ 使用者操作流程       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 1. 點擊樹狀節點      │
│    → toggleSelected()│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 2. 點擊「移動階層」  │
│    按鈕              │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 3. 開啟 MoveDialog   │
│    選擇目標父節點    │
│    選擇要移動設備    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 4. 點擊「確認移動」  │
│    → handleMove()    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ store.moveNodes()    │
│ (nodesStore)        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 【前端驗證】         │
│ store.canMove()      │
│                     │
│ 檢查項目：           │
│ ✓ 至少選擇一個節點   │
│ ✓ 是否同階層         │
│ ✓ 節點是否存在       │
│ ✓ 目標父節點存在     │
│ ✓ 不可移到自身       │
│ ✓ 不可移到子孫       │
│ ✓ 不可移到原位置     │
└──────────┬──────────┘
           │
           ▼ (驗證通過)
┌─────────────────────┐
│ 呼叫 API             │
│ PATCH /api/nodes/move│
│ {                    │
│   node_ids: [5, 6],  │
│   target_parent_id: 1│
│ }                    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 【後端驗證】         │
│ server.js            │
│ (再次驗證相同規則)   │
└──────────┬──────────┘
           │
           ▼ (驗證通過)
┌─────────────────────┐
│ 更新 db.json         │
│ (模擬資料庫)         │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ API 回傳            │
│ {                   │
│   success: true,    │
│   moved: [5, 6]     │
│ }                   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 重新載入資料         │
│ await loadNodes()    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 更新 Pinia store     │
│ store.nodes         │
│ (取得最新資料)       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 清空選取狀態         │
│ clearSelection()     │
└─────────────────────┘
```

**程式碼位置**:

- `app/components/ElectricityMeterTree.vue`: 第 127-134 行
- `app/stores/nodesStore.ts`: 第 200-231 行
- `app/stores/nodesStore.ts`: 第 139-195 行（驗證邏輯）
- `server/server.js`: 第 93-134 行（後端驗證）

---

## 資料流向

### 整體架構圖

```
┌─────────────────────────────────────────────────────────┐
│                     後端層                               │
│  ┌──────────────┐                                       │
│  │  db.json     │  ← 模擬資料庫（JSON 檔案）            │
│  └──────┬───────┘                                       │
│         │                                               │
│  ┌──────▼───────┐                                       │
│  │ server.js    │  ← json-server + 自訂路由            │
│  │              │    - GET /nodes                      │
│  │              │    - PATCH /nodes/move                │
│  └──────┬───────┘                                       │
└─────────┼───────────────────────────────────────────────┘
          │ HTTP API
          │
┌─────────▼───────────────────────────────────────────────┐
│                     前端層                               │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │         API 層 (Composables)                     │  │
│  │  ┌──────────────────────────────────────────┐   │  │
│  │  │ useNodesAPI()                            │   │  │
│  │  │  - fetchNodes()                          │   │  │
│  │  │  - moveNodes()                           │   │  │
│  │  └──────────────────────────────────────────┘   │  │
│  └───────────────────┬──────────────────────────────┘  │
│                      │                                   │
│  ┌───────────────────▼──────────────────────────────┐  │
│  │        狀態管理層 (Pinia Store)                  │  │
│  │  ┌──────────────────────────────────────────┐   │  │
│  │  │ nodesStore                                │   │  │
│  │  │  State:                                   │   │  │
│  │  │    - nodes: Node[]                       │   │  │
│  │  │    - selectedIds: number[]                │   │  │
│  │  │    - expandedIds: number[]                │   │  │
│  │  │    - loading: boolean                     │   │  │
│  │  │    - error: string | null                 │   │  │
│  │  │                                            │   │  │
│  │  │  Getters:                                 │   │  │
│  │  │    - treeNodes                            │   │  │
│  │  │    - isSelectionValid                     │   │  │
│  │  │    - selectedParentId                     │   │  │
│  │  │                                            │   │  │
│  │  │  Actions:                                 │   │  │
│  │  │    - loadNodes()                          │   │  │
│  │  │    - setSelected()                        │   │  │
│  │  │    - toggleSelected()                     │   │  │
│  │  │    - canMove()                            │   │  │
│  │  │    - moveNodes()                          │   │  │
│  │  └──────────────────────────────────────────┘   │  │
│  └───────────────────┬──────────────────────────────┘  │
│                      │                                   │
│  ┌───────────────────▼──────────────────────────────┐  │
│  │        本地儲存層 (localStorage)                 │  │
│  │  ┌──────────────────────────────────────────┐   │  │
│  │  │ localStorage                             │   │  │
│  │  │  - selectedIds (選取狀態)                │   │  │
│  │  │  - expandedIds (展開狀態)                │   │  │
│  │  │  - theme (主題設定)                      │   │  │
│  │  └──────────────────────────────────────────┘   │  │
│  └───────────────────┬──────────────────────────────┘  │
│                      │                                   │
│  ┌───────────────────▼──────────────────────────────┐  │
│  │        視圖層 (Vue Components)                   │  │
│  │  ┌──────────────────────────────────────────┐   │  │
│  │  │ index.vue                                │   │  │
│  │  │ ElectricityMeterTree.vue                 │   │  │
│  │  │ MoveDialog.vue                            │   │  │
│  │  └──────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 狀態管理

### Pinia Store 詳細說明

**檔案**: `app/stores/nodesStore.ts`

#### State（狀態）

```typescript
interface NodesState {
  nodes: Node[]; // 扁平化的節點資料陣列
  selectedIds: number[]; // 已選取的節點 ID 陣列
  expandedIds: number[]; // 展開的節點 ID 陣列
  loading: boolean; // 載入中狀態
  error: string | null; // 錯誤訊息
}
```

#### Getters（計算屬性）

1. **`treeNodes`**: 將扁平化資料轉換為樹狀結構

   - 使用 `flatToTree()` 工具函式
   - 用於 `v-treeview` 元件顯示

2. **`isSelectionValid`**: 驗證選取的節點是否在同一階層

   - 使用 `areSameLevel()` 工具函式
   - 用於顯示警告訊息

3. **`selectedParentId`**: 取得選取節點的父節點 ID
   - 用於移動對話框預設目標父節點

#### Actions（動作）

1. **`loadNodes()`**

   - 從 API 載入節點資料
   - 從 localStorage 恢復 UI 狀態
   - 設定 loading 和 error 狀態

2. **`setSelected(ids: number[])`**

   - 設定選取的節點
   - 驗證是否同階層
   - 同步到 localStorage

3. **`toggleSelected(id: number)`**

   - 切換單一節點的選取狀態
   - 自動處理跨階層選取（清空重選）
   - 同步到 localStorage

4. **`clearSelection()`**

   - 清空所有選取
   - 同步到 localStorage

5. **`setExpanded(ids: number[])`**

   - 設定展開的節點
   - 同步到 localStorage

6. **`canMove(nodeIds, targetParentId)`**

   - 驗證移動操作是否合法
   - 回傳 `{ valid: boolean, error?: string }`
   - 包含完整的驗證規則

7. **`moveNodes(nodeIds, targetParentId)`**
   - 執行移動操作
   - 前端驗證 → API 呼叫 → 重新載入資料
   - 錯誤處理與狀態管理

---

**最後更新**: 2025-12-19
