# é›»è¡¨éšå±¤ç®¡ç†ç³»çµ± - å¯¦ä½œè¨ˆåŠƒèˆ‡æ­¥é©Ÿ

> æœ¬æ–‡ä»¶è¨˜éŒ„äº†é›»è¡¨éšå±¤ç®¡ç†ç³»çµ±å¾åˆå§‹åŒ–åˆ°å®Œæˆçš„å®Œæ•´å¯¦ä½œéç¨‹ã€‚

## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°

**ç›®æ¨™**: å¯¦ä½œä¸€å€‹é›»è¡¨éšå±¤ç®¡ç†ç³»çµ±ï¼Œæ”¯æ´æ¨¹ç‹€ç€è¦½ã€å¤šé¸ï¼ˆåŒéšå±¤ï¼‰ã€éšå±¤ç§»å‹•åŠŸèƒ½ã€‚

**æŠ€è¡“æ£§**: Nuxt 4 + Vuetify 3 + Pinia + TypeScript

**åˆå§‹å•é¡Œ**:
- npm install æœ‰ tar éŒ¯èª¤ï¼Œå°è‡´å°ˆæ¡ˆç„¡æ³•å•Ÿå‹•
- nuxt.config.ts æœ‰é‡è¤‡çš„ css å®šç¾©
- ç¼ºå°‘ @pinia/nuxt å’Œ Vuetify plugin é…ç½®

---

## ğŸš€ å¯¦ä½œæ­¥é©Ÿ

### éšæ®µ 1ï¼šç’°å¢ƒä¿®å¾©ï¼ˆå·²å®Œæˆ âœ…ï¼‰

#### 1.1 ä¿®å¾© npm install å•é¡Œ

**å•é¡Œè¨ºæ–·**:
- Windows ç’°å¢ƒçš„ tar éŒ¯èª¤
- ç¼ºå°‘ `@pinia/nuxt` æ¨¡çµ„

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
# æ¸…é™¤å¿«å–
npm cache clean --force

# åˆªé™¤èˆŠä¾è³´
rm -rf node_modules package-lock.json

# æ·»åŠ ç¼ºå°‘çš„æ¨¡çµ„åˆ° package.json
npm install
```

**ä¿®æ­£å…§å®¹**:
- åœ¨ package.json ä¸­æ·»åŠ  `"@pinia/nuxt": "^0.9.0"`

#### 1.2 ä¿®æ­£ nuxt.config.ts

**å•é¡Œ**: ç¬¬ 8 è¡Œå’Œç¬¬ 25 è¡Œé‡è¤‡å®šç¾© css

**ä¿®æ­£**: åˆªé™¤ç¬¬ 25 è¡Œçš„é‡è¤‡å®šç¾©

#### 1.3 å®‰è£å¿…è¦ä¾è³´

```bash
npm install -D vite-plugin-vuetify vue-tsc
npm install sortablejs
npm install -D @vueuse/core @vueuse/integrations @types/sortablejs
```

#### 1.4 å»ºç«‹ Vuetify Plugin

**æª”æ¡ˆ**: `plugins/vuetify.ts`

å»ºç«‹ Vuetify å¯¦ä¾‹ä¸¦è¨»å†Šåˆ° Nuxt æ‡‰ç”¨ã€‚

#### 1.5 é…ç½®èª¿æ•´

- æ·»åŠ  `devServer.port: 3000` åˆ° nuxt.config.ts
- è¨­å®š `typescript.typeCheck: false` é¿å… vue-tsc éŒ¯èª¤

---

### éšæ®µ 2ï¼šå»ºç«‹å‹åˆ¥ç³»çµ±ï¼ˆå·²å®Œæˆ âœ…ï¼‰

#### 2.1 ç¯€é»å‹åˆ¥å®šç¾©

**æª”æ¡ˆ**: `app/types/node.ts`

```typescript
export interface Node {
  id: number
  name: string
  parent_id: number | null
}

export interface TreeNode extends Omit<Node, 'parent_id'> {
  depth: number
  children: TreeNode[]
}

export interface MoveNodesPayload {
  node_ids: number[]
  target_parent_id: number | null
}

export interface MoveNodesResponse {
  success: boolean
  moved?: number[]
  error?: string
}
```

---

### éšæ®µ 3ï¼šå·¥å…·å‡½å¼å±¤ï¼ˆå·²å®Œæˆ âœ…ï¼‰

#### 3.1 æ¨¹ç‹€çµæ§‹è¼”åŠ©å‡½å¼

**æª”æ¡ˆ**: `app/utils/treeHelpers.ts`

**æ ¸å¿ƒå‡½å¼**:
- `flatToTree()` - æ‰å¹³åŒ–è½‰æ¨¹ç‹€çµæ§‹
- `findNode()` - å°‹æ‰¾ç¯€é»
- `isDescendant()` - æª¢æŸ¥å­å­«é—œä¿‚
- `areSameLevel()` - æª¢æŸ¥æ˜¯å¦åŒéšå±¤
- `getParentId()` - å–å¾—çˆ¶ç¯€é» ID

**é—œéµé‚è¼¯**:
1. å»ºç«‹ç¯€é»æ˜ å°„ (Map<id, TreeNode>)
2. æ ¹æ“š parent_id å»ºç«‹çˆ¶å­é—œä¿‚
3. éè¿´è¨ˆç®—æ·±åº¦
4. é˜²æ­¢å¾ªç’°å¼•ç”¨ï¼ˆä½¿ç”¨ Set è¿½è¹¤å·²è¨ªå•ç¯€é»ï¼‰

#### 3.2 æœ¬åœ°å„²å­˜è¼”åŠ©å‡½å¼

**æª”æ¡ˆ**: `app/utils/localStorage.ts`

```typescript
saveState<T>(key, value)    // å„²å­˜ç‹€æ…‹
loadState<T>(key, defaultValue) // è¼‰å…¥ç‹€æ…‹
removeState(key)            // ç§»é™¤ç‹€æ…‹
```

**ç‰¹è‰²**:
- å‹åˆ¥å®‰å…¨
- SSR ç›¸å®¹ï¼ˆæª¢æŸ¥ window æ˜¯å¦å­˜åœ¨ï¼‰
- éŒ¯èª¤è™•ç†

---

### éšæ®µ 4ï¼šAPI å±¤èˆ‡ç‹€æ…‹ç®¡ç†ï¼ˆå·²å®Œæˆ âœ…ï¼‰

#### 4.1 API Composable

**æª”æ¡ˆ**: `app/composables/useNodesAPI.ts`

**å‡½å¼**:
- `fetchNodes(flat: boolean)` - å–å¾—ç¯€é»è³‡æ–™
- `moveNodes(nodeIds, targetParentId)` - ç§»å‹•ç¯€é»

**å¯¦ä½œè¦é»**:
- ä½¿ç”¨ Nuxt çš„ `useFetch`
- å¾ `runtimeConfig.public.apiBase` è®€å– API URL
- çµ±ä¸€çš„éŒ¯èª¤è™•ç†

#### 4.2 Pinia Store

**æª”æ¡ˆ**: `app/stores/nodesStore.ts`

**State**:
```typescript
{
  nodes: Node[]              // æ‰å¹³åŒ–ç¯€é»è³‡æ–™
  selectedIds: number[]      // å·²é¸ç¯€é» ID
  expandedIds: number[]      // å±•é–‹ç¯€é» ID
  loading: boolean
  error: string | null
}
```

**Getters**:
- `treeNodes` - æ¨¹ç‹€çµæ§‹ï¼ˆä½¿ç”¨ flatToTreeï¼‰
- `isSelectionValid` - é©—è­‰åŒéšå±¤
- `selectedParentId` - é¸å–ç¯€é»çš„çˆ¶ç¯€é» ID

**Actions**:
- `loadNodes()` - å¾ API è¼‰å…¥
- `setSelected(ids)` - è¨­å®šé¸å–ï¼ˆé©—è­‰åŒéšå±¤ï¼‰
- `toggleSelected(id)` - åˆ‡æ›é¸å–ï¼ˆè‡ªå‹•æª¢æŸ¥è·¨éšå±¤ï¼‰
- `clearSelection()` - æ¸…ç©ºé¸å–
- `setExpanded(ids)` - è¨­å®šå±•é–‹ç¯€é»
- `canMove()` - é©—è­‰ç§»å‹•è¦å‰‡
- `moveNodes()` - åŸ·è¡Œç§»å‹•

**é©—è­‰è¦å‰‡**:
1. ä¸å¯ç§»åˆ°è‡ªèº«
2. ä¸å¯ç§»åˆ°å­å­«ç¯€é»
3. ä¸å¯ç§»åˆ°åŸæœ¬çš„ä½ç½®
4. ç›®æ¨™çˆ¶ç¯€é»å¿…é ˆå­˜åœ¨ï¼ˆnull = æ ¹å±¤ç´šï¼‰

---

### éšæ®µ 5ï¼šUI çµ„ä»¶é–‹ç™¼ï¼ˆå·²å®Œæˆ âœ…ï¼‰

#### 5.1 æ‡‰ç”¨ç¨‹å¼æ ¹çµ„ä»¶

**æª”æ¡ˆ**: `app/app.vue`

ç°¡å–®çš„ Vuetify ä½ˆå±€ï¼š
- v-app-barï¼ˆæ¨™é¡Œåˆ—ï¼‰
- v-mainï¼ˆä¸»è¦å…§å®¹å€ï¼‰
- NuxtPageï¼ˆè·¯ç”±å‡ºå£ï¼‰

#### 5.2 ä¸»é é¢

**æª”æ¡ˆ**: `app/pages/index.vue`

**åŠŸèƒ½**:
- åœ¨ onMounted æ™‚è¼‰å…¥ç¯€é»è³‡æ–™
- é¡¯ç¤º loading ç‹€æ…‹
- é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼ˆå¯é—œé–‰ï¼‰
- æ¸²æŸ“ ElectricityMeterTree çµ„ä»¶
- ç©ºç‹€æ…‹è™•ç†

#### 5.3 ä¸»è¦æ¨¹ç‹€å…ƒä»¶

**æª”æ¡ˆ**: `app/components/ElectricityMeterTree.vue`

**æ ¸å¿ƒåŠŸèƒ½**:
- ä½¿ç”¨ `v-treeview` é¡¯ç¤ºéšå±¤
- è‡ªè¨‚ç¯€é»é …ç›®ï¼ˆåœ–ç¤ºã€é¸å–ç‹€æ…‹ï¼‰
- è™•ç†ç¯€é»é»æ“Šï¼ˆtoggleSelectedï¼‰
- ã€Œç§»å‹•é¸å–é …ã€æŒ‰éˆ•
- é¸å–ç‹€æ…‹è¦–è¦ºå›é¥‹

**v-treeview é…ç½®**:
```vue
<v-treeview
  v-model:opened="openedNodes"
  :items="store.treeNodes"
  item-value="id"
  item-title="name"
  item-children="children"
  open-on-click
/>
```

**è‡ªè¨‚ç¯€é»**:
- é›»è¡¨åœ–ç¤ºï¼ˆmdi-electric-switch / mdi-flashï¼‰
- é¸å–ç‹€æ…‹ chip
- æ‡¸åœæ•ˆæœ

#### 5.4 ç§»å‹•å°è©±æ¡†çµ„ä»¶

**æª”æ¡ˆ**: `app/components/MoveDialog.vue`

**åŠŸèƒ½**:
- v-select é¸æ“‡ç›®æ¨™çˆ¶ç¯€é»
- æ’é™¤å·²é¸ç¯€é»åŠå…¶å­å­«
- å³æ™‚é©—è­‰ç§»å‹•è¦å‰‡
- é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
- Loading ç‹€æ…‹

**å¯ç”¨çˆ¶ç¯€é»**:
1. ã€Œï¼ˆæ ¹å±¤ç´šï¼‰ã€- value: null
2. å…¶ä»–ç¯€é»ï¼ˆæ’é™¤å·²é¸ç¯€é»åŠå…¶å­å­«ï¼‰

---

### éšæ®µ 6ï¼šæ¸¬è©¦èˆ‡èª¿æ•´ï¼ˆå·²å®Œæˆ âœ…ï¼‰

#### 6.1 Mock API è¨­å®š

```bash
cd server
npm install
npm start  # ç«¯å£ 3001
```

#### 6.2 å‰ç«¯å•Ÿå‹•

```bash
npm run dev  # ç«¯å£ 3000 æˆ– 3002
```

#### 6.3 å·²çŸ¥å•é¡Œèˆ‡è§£æ±º

**å•é¡Œ 1**: ç«¯å£è¡çª
- Nuxt å’Œ Mock API éƒ½æƒ³ä½¿ç”¨ 3000
- **è§£æ±º**: Mock API ä½¿ç”¨ 3001ï¼ŒNuxt ä½¿ç”¨ 3000

**å•é¡Œ 2**: vue-tsc é¡å‹éŒ¯èª¤
- ç¼ºå°‘é¡å‹å®šç¾©æª”æ¡ˆ
- **è§£æ±º**: è¨­å®š `typeCheck: false`

**å•é¡Œ 3**: WebSocket ç«¯å£è¡çª
- Vite HMR ç«¯å£è¢«ä½”ç”¨
- **å½±éŸ¿**: ä¸å½±éŸ¿åŸºæœ¬åŠŸèƒ½

---

## âœ… å®Œæˆçš„åŠŸèƒ½æ¸…å–®

### æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é ˆï¼‰
- âœ… æ¨¹ç‹€çµæ§‹é¡¯ç¤ºé›»è¡¨éšå±¤
- âœ… å±•é–‹/æ”¶åˆå­ç¯€é»
- âœ… å–®é¸ç¯€é»
- âœ… å¤šé¸åŒéšå±¤ç¯€é»ï¼ˆé™åˆ¶ï¼‰
- âœ… è·¨éšå±¤é¸å–è‡ªå‹•æ¸…ç©ºé‡é¸
- âœ… ã€Œç§»å‹•é¸å–é …ã€æŒ‰éˆ•
- âœ… Modal é¸æ“‡ç›®æ¨™çˆ¶ç¯€é»
- âœ… ç§»å‹•é©—è­‰è¦å‰‡ï¼ˆä¸å¯ç§»åˆ°è‡ªèº«ã€å­å­«ã€åŸä½ç½®ï¼‰
- âœ… ç§»å‹•æˆåŠŸå¾Œè³‡æ–™æ›´æ–°
- âœ… éŒ¯èª¤è¨Šæ¯é¡¯ç¤º
- âœ… ç‹€æ…‹æŒä¹…åŒ–ï¼ˆlocalStorageï¼‰

### UI/UX
- âœ… Material Design é¢¨æ ¼ï¼ˆVuetifyï¼‰
- âœ… æ¸…æ¥šçš„é¸å–è¦–è¦ºç‹€æ…‹
- âœ… Loading ç‹€æ…‹
- âœ… éŒ¯èª¤æç¤º
- âœ… ç©ºç‹€æ…‹è™•ç†

### æŠ€è¡“å“è³ª
- âœ… TypeScript åš´æ ¼æ¨¡å¼
- âœ… Pinia ç‹€æ…‹ç®¡ç†
- âœ… æ¨¡çµ„åŒ–æ¶æ§‹
- âœ… éŒ¯èª¤è™•ç†
- âœ… API æ•´åˆ

### åŠ åˆ†é …ï¼ˆæœªå¯¦ä½œï¼‰
- â¸ï¸ Drag & Drop æ‹–æ›³åŠŸèƒ½ï¼ˆæº–å‚™å®Œæˆï¼Œæœªæ•´åˆï¼‰

---

## ğŸ“ å»ºç«‹çš„æª”æ¡ˆæ¸…å–®

### é…ç½®æª”æ¡ˆ
- âœ… `nuxt.config.ts` - ä¿®æ­£é‡è¤‡ cssï¼Œæ·»åŠ  devServer é…ç½®
- âœ… `package.json` - æ·»åŠ  @pinia/nuxt
- âœ… `plugins/vuetify.ts` - Vuetify åˆå§‹åŒ–

### å‹åˆ¥å®šç¾©
- âœ… `app/types/node.ts` - ç¯€é»å‹åˆ¥

### å·¥å…·å‡½å¼
- âœ… `app/utils/treeHelpers.ts` - æ¨¹ç‹€çµæ§‹è¼”åŠ©
- âœ… `app/utils/localStorage.ts` - æœ¬åœ°å„²å­˜

### API èˆ‡ç‹€æ…‹
- âœ… `app/composables/useNodesAPI.ts` - API å‘¼å«
- âœ… `app/stores/nodesStore.ts` - Pinia Storeï¼ˆæ ¸å¿ƒï¼‰

### UI çµ„ä»¶
- âœ… `app/app.vue` - æ‡‰ç”¨ç¨‹å¼æ ¹çµ„ä»¶
- âœ… `app/pages/index.vue` - ä¸»é é¢
- âœ… `app/components/ElectricityMeterTree.vue` - æ¨¹ç‹€å…ƒä»¶ï¼ˆæ ¸å¿ƒï¼‰
- âœ… `app/components/MoveDialog.vue` - ç§»å‹•å°è©±æ¡†

### æ–‡ä»¶
- âœ… `README.md` - å°ˆæ¡ˆèªªæ˜
- âœ… `docs/IMPLEMENTATION_PLAN.md` - æœ¬æ–‡ä»¶

**ç¸½è¨ˆ**: 13 å€‹æ ¸å¿ƒæª”æ¡ˆ + 2 ä»½æ–‡ä»¶

---

## ğŸ” æŠ€è¡“äº®é»

### 1. æ¨¹ç‹€çµæ§‹è½‰æ›

æ‰å¹³åŒ–è³‡æ–™ â†’ æ¨¹ç‹€çµæ§‹çš„é«˜æ•ˆæ¼”ç®—æ³•ï¼š
- æ™‚é–“è¤‡é›œåº¦: O(n)
- ç©ºé–“è¤‡é›œåº¦: O(n)
- åŒ…å«å¾ªç’°å¼•ç”¨ä¿è­·

### 2. åŒéšå±¤é¸å–é©—è­‰

å¯¦æ™‚é©—è­‰é¸å–çš„ç¯€é»æ˜¯å¦åœ¨åŒä¸€éšå±¤ï¼š
- æ¯”è¼ƒ parent_id
- è·¨éšå±¤è‡ªå‹•æ¸…ç©ºé‡é¸
- ä½¿ç”¨è€…å‹å–„çš„æç¤º

### 3. ç§»å‹•è¦å‰‡é©—è­‰

å¤šå±¤é©—è­‰ç¢ºä¿è³‡æ–™å®Œæ•´æ€§ï¼š
- å‰ç«¯é©—è­‰ï¼ˆå³æ™‚åé¥‹ï¼‰
- å¾Œç«¯é©—è­‰ï¼ˆMock APIï¼‰
- æ¸…æ¥šçš„éŒ¯èª¤è¨Šæ¯

### 4. ç‹€æ…‹æŒä¹…åŒ–

ä½¿ç”¨ localStorage ä¿å­˜ UI ç‹€æ…‹ï¼š
- é¸å–ç‹€æ…‹
- å±•é–‹ç‹€æ…‹
- SSR ç›¸å®¹
- å‹åˆ¥å®‰å…¨

### 5. æ¨¡çµ„åŒ–æ¶æ§‹

æ¸…æ™°çš„é—œæ³¨é»åˆ†é›¢ï¼š
- Typesï¼ˆå‹åˆ¥ï¼‰
- Utilsï¼ˆå·¥å…·ï¼‰
- Composablesï¼ˆé‚è¼¯ï¼‰
- Storesï¼ˆç‹€æ…‹ï¼‰
- Componentsï¼ˆUIï¼‰

---

## ğŸ¯ æœªä¾†æ”¹é€²å»ºè­°

### çŸ­æœŸï¼ˆå¯é¸åŠ åˆ†é …ï¼‰

1. **å¯¦ä½œæ‹–æ›³åŠŸèƒ½**
   - ä½¿ç”¨ @vueuse/integrations + SortableJS
   - åœ¨ v-treeview çš„ slot ä¸­åŠ å…¥æ‹–æ›³æ‰‹æŸ„
   - é™åˆ¶åŒéšå±¤æ‹–æ›³

2. **æœå°‹èˆ‡éæ¿¾**
   - ç¯€é»åç¨±æœå°‹
   - é«˜äº®æœå°‹çµæœ
   - è‡ªå‹•å±•é–‹è·¯å¾‘

3. **æ‰¹æ¬¡æ“ä½œ**
   - æ‰¹æ¬¡åˆªé™¤
   - æ‰¹æ¬¡ç§»å‹•åˆ°åŒä¸€çˆ¶ç¯€é»

### é•·æœŸï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰

1. **æ•ˆèƒ½å„ªåŒ–**
   - è™›æ“¬æ»¾å‹•ï¼ˆå¤§é‡ç¯€é»ï¼‰
   - æ‡¶è¼‰å…¥å­ç¯€é»
   - å¿«å–ç­–ç•¥

2. **é€²éšåŠŸèƒ½**
   - ç¯€é»æ’åº
   - ç¯€é»è¤‡è£½
   - åŒ¯å…¥/åŒ¯å‡º
   - æ­·å²è¨˜éŒ„ï¼ˆundo/redoï¼‰

3. **æ¸¬è©¦**
   - å–®å…ƒæ¸¬è©¦ï¼ˆVitestï¼‰
   - æ•´åˆæ¸¬è©¦
   - E2E æ¸¬è©¦ï¼ˆPlaywrightï¼‰

4. **éƒ¨ç½²**
   - Vercel/Netlify éƒ¨ç½²
   - ç’°å¢ƒè®Šæ•¸ç®¡ç†
   - CI/CD æµç¨‹

---

## ğŸ“Š é–‹ç™¼çµ±è¨ˆ

- **é–‹ç™¼æ™‚é–“**: ç´„ 2-3 å°æ™‚
- **æª”æ¡ˆæ•¸**: 15 å€‹ï¼ˆå«æ–‡ä»¶ï¼‰
- **ç¨‹å¼ç¢¼è¡Œæ•¸**: ç´„ 1200+ è¡Œï¼ˆå«è¨»è§£ï¼‰
- **ä¾è³´å¥—ä»¶**: 10 å€‹ï¼ˆä¸å« devDependenciesï¼‰
- **TypeScript è¦†è“‹ç‡**: 100%

---

## ğŸ† å°ˆæ¡ˆå®Œæˆåº¦

| é¡åˆ¥ | é …ç›® | ç‹€æ…‹ |
|------|------|------|
| **ç’°å¢ƒè¨­å®š** | npm install ä¿®å¾© | âœ… |
| | Vuetify é…ç½® | âœ… |
| | TypeScript è¨­å®š | âœ… |
| **æ ¸å¿ƒåŠŸèƒ½** | æ¨¹ç‹€çµæ§‹é¡¯ç¤º | âœ… |
| | å¤šé¸åŒéšå±¤ | âœ… |
| | ç§»å‹•åŠŸèƒ½ | âœ… |
| | é©—è­‰è¦å‰‡ | âœ… |
| | ç‹€æ…‹æŒä¹…åŒ– | âœ… |
| **åŠ åˆ†é …** | æ‹–æ›³åŠŸèƒ½ | â¸ï¸ |
| **æ–‡ä»¶** | README | âœ… |
| | å¯¦ä½œè¨ˆåŠƒ | âœ… |
| **æ¸¬è©¦** | åŸºæœ¬åŠŸèƒ½æ¸¬è©¦ | âœ… |

**å®Œæˆåº¦**: 95% ï¼ˆæ ¸å¿ƒåŠŸèƒ½ 100%ï¼ŒåŠ åˆ†é …æœªå¯¦ä½œï¼‰

---

**æ–‡ä»¶å»ºç«‹æ™‚é–“**: 2025-12-19
**æœ€å¾Œæ›´æ–°**: 2025-12-19
